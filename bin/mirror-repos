#!/bin/bash

set -eu -o pipefail

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/.."

cd "$DIR"

alias=$( basename "$PWD" )

mc config host add "$alias" https://s3.amazonaws.com "$AWS_ACCESS_KEY_ID" "$AWS_SECRET_ACCESS_KEY" S3v4

for file in $( cd repos ; find . -name repository.xml ); do
  file=$( echo "$file" | cut -c3- )

  mc cp $PWD/repos/$file $alias/$S3_REPOS_BUCKET/$S3_REPOS_PREFIX$file
done

mc config host remove "$alias"
